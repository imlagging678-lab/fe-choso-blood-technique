local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- [AYARLAR]
local toolName = "Piercing Blood"
local animID = "rbxassetid://93648331" -- Yeni Enrage Animasyonu
local lockPoint = 0.20 -- Senin istediğin omuz kalkış noktası
local tiltAngle = 15 
local downOffset = -0.5

-- [TOOL OLUŞTURMA]
local tool = Instance.new("Tool")
tool.Name = toolName
tool.RequiresHandle = false
tool.Parent = player:WaitForChild("Backpack")

local animation = Instance.new("Animation")
animation.AnimationId = animID
local animTrack, stayPos
local isEquipped, isFiring = false, false

local highlight = Instance.new("Highlight")
highlight.FillColor = Color3.fromRGB(150, 0, 0)
highlight.OutlineColor = Color3.fromRGB(255, 0, 0)

-- [ANA MOTOR]
RunService.Heartbeat:Connect(function()
    if isEquipped and player.Character then
        local HRP = player.Character:FindFirstChild("HumanoidRootPart")
        if not HRP or not stayPos then return end

        -- [[ PUNCH-STYLE ANIMATION LOCK ]]
        if animTrack and animTrack.Length > 0 then
            animTrack.TimePosition = animTrack.Length * lockPoint
            animTrack:AdjustSpeed(0) -- Hareketi sıfırla
        end

        local target = mouse.Target
        if target and target.Parent and target.Parent:FindFirstChild("Humanoid") then
            highlight.Adornee = target.Parent
            highlight.Parent = target.Parent
        else
            highlight.Parent = nil
        end

        if isFiring and highlight.Adornee and highlight.Adornee:FindFirstChild("HumanoidRootPart") then
            local enemyHRP = highlight.Adornee.HumanoidRootPart
            HRP.Velocity = Vector3.new(999999, 999999, 999999)
            HRP.CFrame = enemyHRP.CFrame * CFrame.Angles(math.random(-180, 180), math.random(-180, 180), math.random(-180, 180))
            RunService.RenderStepped:Wait()
            HRP.CFrame = stayPos
            HRP.Velocity = Vector3.new(0, 0, 0)
        else
            HRP.CFrame = stayPos
            HRP.Velocity = Vector3.new(0, 0, 0)
        end
    end
end)

tool.Activated:Connect(function() isFiring = true end)
tool.Deactivated:Connect(function() isFiring = false end)

tool.Equipped:Connect(function()
    local char = player.Character
    local hrp = char:WaitForChild("HumanoidRootPart")
    local hum = char:WaitForChild("Humanoid")
    local animator = hum:WaitForChild("Animator")

    stayPos = hrp.CFrame * CFrame.new(0, downOffset, 0) * CFrame.Angles(math.rad(tiltAngle), 0, 0)
    isEquipped = true
    
    animTrack = animator:LoadAnimation(animation)
    animTrack.Priority = Enum.AnimationPriority.Action4
    animTrack:Play(0.1, 20, 1) -- Ağırlığı 20 yaparak pozu iyice bastırıyoruz
    hum.PlatformStand = true
end)

tool.Unequipped:Connect(function()
    isEquipped, isFiring = false, false
    stayPos = nil
    highlight.Parent = nil
    if animTrack then 
        animTrack:Stop(0) 
        animTrack:Destroy() 
    end
    if player.Character then
        player.Character.Humanoid.PlatformStand = false
    end
end)
