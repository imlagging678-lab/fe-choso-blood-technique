local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- [AYARLAR]
local toolName = "Piercing Blood"
local animID = "rbxassetid://182724289"
local tiltAngle = -15
local downOffset = -0.8

local tool = Instance.new("Tool")
tool.Name = toolName
tool.RequiresHandle = false
tool.Parent = player:WaitForChild("Backpack")

local animation = Instance.new("Animation")
animation.AnimationId = animID
local animTrack, rootJoint, originalC0, stayPos
local isEquipped, isFiring = false, false

-- [HIGHLIGHT]
local highlight = Instance.new("Highlight")
highlight.FillColor = Color3.fromRGB(150, 0, 0)
highlight.OutlineColor = Color3.fromRGB(255, 0, 0)

-- [SENİN WALKFLING MOTORUNUN ENTEGRASYONU]
RunService.Heartbeat:Connect(function()
    if isEquipped and player.Character then
        local HRP = player.Character:FindFirstChild("HumanoidRootPart")
        if not HRP or not stayPos then return end

        -- 1. Hedef Takibi (Highlight)
        local target = mouse.Target
        if target and target.Parent and target.Parent:FindFirstChild("Humanoid") then
            highlight.Adornee = target.Parent
            highlight.Parent = target.Parent
        else
            highlight.Parent = nil
        end

        -- 2. SENİN WALKFLING SİSTEMİNİN TETİKLENMESİ
        if isFiring and highlight.Adornee and highlight.Adornee:FindFirstChild("HumanoidRootPart") then
            local enemyHRP = highlight.Adornee.HumanoidRootPart
            
            -- IŞINLANMA VE SENİN WALKFLING GÜCÜN
            HRP.Velocity = Vector3.new(999999, 999999, 999999) -- Senin walkfling hızın
            HRP.CFrame = enemyHRP.CFrame * CFrame.Angles(math.random(-360, 360), math.random(-360, 360), math.random(-360, 360))
            
            -- Ghost Efekti: Vuruşu yap ve salisede geri dön
            RunService.RenderStepped:Wait()
            HRP.CFrame = stayPos
            HRP.Velocity = Vector3.new(0, 0, 0)
        else
            -- DURURKEN SABİTLEME (Animasyonu bozmaz)
            HRP.CFrame = stayPos
            HRP.Velocity = Vector3.new(0, 0, 0)
            HRP.RotVelocity = Vector3.new(0, 0, 0)
        end
    end
end)

-- [TUŞ KONTROLLERİ]
tool.Activated:Connect(function() isFiring = true end)
tool.Deactivated:Connect(function() isFiring = false end)

-- [EQUIP & DURUŞ]
tool.Equipped:Connect(function()
    local char = player.Character
    local hrp = char:WaitForChild("HumanoidRootPart")
    local hum = char:WaitForChild("Humanoid")

    stayPos = hrp.CFrame
    isEquipped = true
    
    -- Bel Bükme (Buttery Smooth)
    rootJoint = hrp:FindFirstChild("RootJoint") or (char:FindFirstChild("LowerTorso") and char.LowerTorso:FindFirstChild("RootJoint"))
    if rootJoint then
        originalC0 = originalC0 or rootJoint.C0
        local target = originalC0 * CFrame.new(0, 0, downOffset) * CFrame.Angles(math.rad(tiltAngle), 0, 0)
        TweenService:Create(rootJoint, TweenInfo.new(0.4), {C0 = target}):Play()
    end

    animTrack = hum:WaitForChild("Animator"):LoadAnimation(animation)
    animTrack.Priority = Enum.AnimationPriority.Action
    animTrack:Play()
    
    hum.PlatformStand = true -- Fiziksel yürüme kapalı, animasyon açık
end)

tool.Unequipped:Connect(function()
    isEquipped = false
    isFiring = false
    stayPos = nil
    highlight.Parent = nil
    if animTrack then animTrack:Stop(0.4) end
    if player.Character then
        player.Character.Humanoid.PlatformStand = false
        if rootJoint and originalC0 then
            TweenService:Create(rootJoint, TweenInfo.new(0.4), {C0 = originalC0}):Play()
        end
    end
end)
